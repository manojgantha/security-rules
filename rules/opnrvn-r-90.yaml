ruleId: opnrvn-r-90
type: asset
ruleName: >
  Ensure "Block Project-wide SSH keys" is enabled for VM instances
description: >
  It is recommended to use Instance specific SSH key(s) instead of using common/shared project-wide SSH key(s) to access Instances.
severity: high
enabled: true
sql: >
  SELECT acc.asset_id
      FROM assets acc,
      LATERAL (
          SELECT value -> 'metadata' as meta
          FROM jsonb_array_elements(supplementary_configuration -> 'instances')
      ) arr
     WHERE acc.resource_type = 'GCP::ComputeEngine::Zone'
     and not exists
        (SELECT value as val
          FROM jsonb_array_elements(meta -> 'items')
          WHERE value ->> 'key' = 'block-project-ssh-keys'
            AND value ->> 'value' = 'true'
          );

remediationDocURLs: https://github.com/openraven/security-rules/wiki
version: 0.9