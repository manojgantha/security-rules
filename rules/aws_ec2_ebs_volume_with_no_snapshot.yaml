id: 1f4045c2-739b-413f-80db-cf4d560835a1
ruleId: aws_056
type: asset
ruleName: >
  Ensure all EC2 EBS Volumes has snapshots
description: >
  Availability of the snapshot could prevent data lose and will simplify restoring in case of data encryption
  Current rule check existence of Snapshots for EBS Volumes of running EC2 instances
severity: high
enabled: true
sql: >
  SELECT DISTINCT ec2.asset_id
  FROM assets ec2,
  LATERAL (
      SELECT value -> 'ebs' AS ebs_device
      FROM jsonb_array_elements(configuration -> 'blockDeviceMappings')
  ) arr
  LEFT JOIN assets snap
  ON (snap.resource_type = 'AWS::EC2::Snapshot'
      AND arr.ebs_device ->> 'volumeId' = snap.configuration ->> 'volumeId')
  WHERE ec2.resource_type = 'AWS::EC2::Instance'
  AND ec2.configuration -> 'state' ->> 'name' = 'running'
  AND arr.ebs_device ->> 'status' = 'attached'
  AND snap.configuration ->> 'snapshotId' is null
remediation: >
  1. Open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.
  2. Choose Snapshots under Elastic Block Store in the navigation pane.
  3. Choose Create Snapshot.
  4. For Select resource type, choose Volume.
  5. For Volume, select the volume.
    (Optional) Enter a description for the snapshot.
    (Optional) Choose Add Tag to add tags to your snapshot. For each tag, provide a tag key and a tag value.
  6. Choose Create Snapshot.
remediationDocURLs:
  - https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html
