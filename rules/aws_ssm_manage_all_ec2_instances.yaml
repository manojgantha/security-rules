id: b1dc3919-5146-4bbc-93d4-7e16b6a2e684
ruleId: aws_057
type: asset
ruleName: >
  Ensure all EC2 instances are managed by SSM
description: >
  Systems Manager helps you maintain security and compliance by scanning your managed instances
  and reporting on (or taking corrective action on) any policy violations it detects.
  In case if SSM is enabled for specific region but EC2 instances are not managed -
  they will not be monitored from any kind of SSM perspective
severity: high
enabled: true
sql: >
  SELECT ec2.asset_id
    FROM assets ec2
    LEFT JOIN assets ssm
      ON (ec2.resource_id = ssm.resource_id AND ssm.resource_type = 'AWS::SSM::Instance')
   WHERE ec2.resource_type = 'AWS::EC2::Instance'
     AND ec2.configuration -> 'state' ->> 'name' = 'running'
     AND ssm.resource_id IS NULL;
remediation: >
  1. Open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.
  2. In the navigation pane, under Instances, choose Instances.
  3. Navigate to and choose your EC2 instance from the list.
  4. In the Actions menu, choose Security, Modify IAM role.
  5. For IAM role, select the instance profile you created for that perspective
remediationDocURLs:
  - https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-setting-up.html
