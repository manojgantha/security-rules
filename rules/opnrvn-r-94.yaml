ruleId: opnrvn-r-94
type: asset
ruleName: >
  Ensure VM disks for critical VMs are encrypted with Customer- Supplied Encryption Keys (CSEK)
description: >
  By default, Google Compute Engine encrypts all data at rest.
  Compute Engine handles and manages this encryption for you without any additional actions on your part.
  However, if you wanted to control and manage this encryption yourself, you can provide your own encryption keys.
severity: medium # Critical VMs only
enabled: true
sql: > # TODO sql refactoring required for disk data only
  SELECT acc.asset_id
      FROM assets acc,
    LATERAL (
      SELECT value -> 'diskEncryptionKey' as meta
      FROM jsonb_array_elements(supplementary_configuration -> 'disks')
      ) arr
    WHERE acc.resource_type = 'GCP::ComputeEngine::Zone'
      AND meta ->> 'sha256' is not null

remediationDocURLs: https://github.com/openraven/security-rules/wiki
version: 0.9