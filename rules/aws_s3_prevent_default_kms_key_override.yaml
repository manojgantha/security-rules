id: b6b640be-94b6-40fb-8e69-0c3917ffeb4f
ruleId: aws_058
type: asset
ruleName: >
  Ensure S3 bucket deny overriding of default KMS Key encryption
description: >
  Attackers which have S3:PutObject permission are still able to override default KMS Key encryption
  on updating object operation with their own provided KMS Key, thus lead ransomware violation
  Bucket owner should define policy to allow objects modification only using the defined default KMS Key,
  which attack unlikely have permissions to change or modify
severity: high
enabled: true
sql: >
  SELECT s3bucket.asset_id,
    FROM assets s3bucket
    JOIN LATERAL (
        SELECT value AS ssec
        FROM jsonb_array_elements(s3bucket.supplementary_configuration -> 'serverSideEncryptionConfiguration' -> 'rules')
    ) arr ON true
    JOIN LATERAL (
        SELECT value AS stmt
        FROM jsonb_array_elements(s3bucket.supplementary_configuration -> 'bucketPolicy' -> 'Statement')
    ) policy ON true
    WHERE s3bucket.resource_type = 'AWS::S3::Bucket'
    AND policy.stmt ->> 'Action' LIKE '%s3:PutObject%'
    AND (policy.stmt ->> 'Condition' IS NULL
          OR policy.stmt ->> 'Condition' not like '%x-amz-server-side-encryption-aws-kms-key-id%')
remediation: >
  Perform the following to enable S3 bucket policy control over KMS Key:
  Via the Management Console
    1. Sign in to the AWS Management Console and open the S3 console at https://console.aws.amazon.com/s3.
    2. In the Buckets list, choose the name of the bucket that you want to create a bucket policy for or whose bucket policy you want to edit.
    3. Choose Permissions.
    4. Under Bucket policy, choose Edit.
    5. In the Policy text field, type or copy and paste a new bucket policy, or edit an existing policy.
       The bucket policy is a JSON file. The text you type in the editor must be valid JSON.
    6. Add policy Condition statement where you define the KMS Key to be matched for Statement with s3:PutObject permission
    7. Condition example for Allow effect for:
       "Condition":{"StringEquals":{"s3:x-amz-server-side-encryption-aws-kms-key-id":"arn:aws:kms:REGION:ACCOUNT-ID:key\/KEY-ID"}}}
remediationDocURLs:
  - https://rhinosecuritylabs.com/aws/s3-ransomware-part-2-prevention-and-defense/#:~:text=Another%20feature%20of,be%20found%20here.
  - https://docs.aws.amazon.com/AmazonS3/latest/userguide/add-bucket-policy.html
  - https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazons3.html
version: 0.1.3
