id: c8f4d501-3358-49fc-9260-9943efc9e654
ruleId: aws_055
type: asset
ruleName: >
  Ensure there no stale roles with Attached Policies for S3 access
description: >
  Avoid stale roles which could cause access leakage and uncontrolled manipulation with S3 bucket data
  which increase risks and leads to Ransomware violations.
  This rule checks Attached policies only. The Inline policies verified under the respective rule.
severity: high
enabled: false
sql: >
  SELECT a.asset_id
  FROM assets a, LATERAL (
      SELECT value ->> 'arn' as attached_policy_arn
      FROM jsonb_array_elements(a.supplementary_configuration -> 'attachedPolicies')
  ) arr
  JOIN assets policy ON (arr.attached_policy_arn = policy.asset_id)
  WHERE a.resource_type = 'AWS::IAM::Role'
  AND (policy.supplementary_configuration::text like '%"s3:%'
      OR policy.supplementary_configuration::text like '%"arn:aws:s3%')
  AND a.configuration ->> 'roleLastUsed' IS NOT NULL
  AND (a.configuration -> 'roleLastUsed' ->> 'lastUsedDate' IS NULL
      OR now() - INTERVAL '60 DAYS' > to_timestamp(a.configuration -> 'roleLastUsed' ->> 'lastUsedDate', 'YYYY-MM-DDTHH:MI:SS'))
remediation: >
  1. Sign in to the AWS Management Console and open the IAM console at https://console.aws.amazon.com/iam/.
  2. In the navigation pane of the IAM console, choose Roles. Then select the check box next to the role name that you want to delete, not the name or row itself.
  3. For Role actions at the top of the page, choose Delete.
  4. In the confirmation dialog box, review the last accessed information, which shows when each of the selected roles last accessed an AWS service.
      This helps you to confirm whether the role is currently active. If you want to proceed, choose Yes, Delete to submit the service-linked role for deletion.
  5. Watch the IAM console notifications to monitor the progress of the service-linked role deletion.
    Because the IAM service-linked role deletion is asynchronous, after you submit the role for deletion, the deletion task can succeed or fail.
    If the task succeeds, then the role is removed from the list and a notification of success appears at the top of the page.
    If the task fails, you can choose View details or View Resources from the notifications to learn why the deletion failed.
    If the deletion fails because the role is using the service's resources, then the notification includes a list of resources, if the service returns that information.
    You can then clean up the resources and submit the deletion again.
remediationDocURLs:
  - https://aws.amazon.com/blogs/security/identify-unused-iam-roles-remove-confidently-last-used-timestamp/
  - https://docs.aws.amazon.com/IAM/latest/UserGuide/using-service-linked-roles.html#delete-service-linked-role
