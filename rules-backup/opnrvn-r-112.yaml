ruleId: opnrvn-r-112
type: asset
ruleName: >
  Ensure that all BigQuery Tables are encrypted with Customer-managed encryption key (CMEK)
description: >
  BigQuery by default encrypts the data as rest by employing Envelope Encryption using Google managed cryptographic keys.
  The data is encrypted using the data encryption keys and data encryption keys themselves are further encrypted using key encryption keys.
  This is seamless and do not require any additional input from the user.
  However, if you want to have greater control, Customer-managed encryption keys (CMEK) can be used as encryption key management solution for BigQuery Data Sets.
  If CMEK is used, the CMEK is used to encrypt the data encryption keys instead of using google-managed encryption keys.
severity: medium # by default encrypted by GMCK which also acceptable
enabled: true
sql: >
  SELECT acc.asset_id
    FROM magpie.assets acc,
  LATERAL (
        SELECT value as tbl
        FROM jsonb_array_elements(acc.supplementary_configuration -> 'tables')
      ) arr
   WHERE acc.resource_type = 'GCP::BigQuery::Dataset'
     AND arr.tbl -> 'encryptionConfiguration' ->> 'kmsKeyName' IS NULL
remediationDocURLs: https://github.com/openraven/security-rules/wiki
version: 0.9