id: b6b640be-94b6-40fb-8e69-0c3917ffeb4f
# opnrvn-r-53
refId: aws-storage-s3-bucket-deny-overriding-of-default-kms-key-encryption
type: asset
name: >
  S3 bucket does not deny overriding of default KMS key encryption
description: >
  Identifies S3 buckets which do not deny overriding of the default KMS key encryption.
severity: high
enabled: true
sql: >
  SELECT s3bucket.arn as assetid
    FROM ${magpie_schema}.awss3bucket s3bucket
    JOIN LATERAL (
        SELECT value AS ssec
        FROM jsonb_array_elements(s3bucket.supplementaryconfiguration -> 'ServerSideEncryptionConfiguration' -> 'rules')
    ) arr ON true
    JOIN LATERAL (
        SELECT value AS stmt
        FROM jsonb_array_elements(s3bucket.supplementaryconfiguration -> 'BucketPolicy' -> 'Statement')
    ) policy ON true
    WHERE policy.stmt ->> 'Action' LIKE '%s3:PutObject%'
    AND (policy.stmt ->> 'Condition' IS NULL
          OR policy.stmt ->> 'Condition' not like '%x-amz-server-side-encryption-aws-kms-key-id%')

remediationDocURLs: https://github.com/openraven/security-rules/wiki
version: 1.0.5
