ruleId: opnrvn-r-104
type: asset
ruleName: >
  Ensure that the log metric filter and alerts exist for Custom Role changes
description: >
  It is recommended that a metric filter and alarm be established for changes to Identity and Access Management (IAM) role
  creation, deletion and updating activities.
severity: high
enabled: true
sql: >
  SELECT 'No log metric filter and alerts exist for Custom Role changes' AS asset_id
  WHERE NOT EXISTS (
      SELECT acc.asset_id
        FROM magpie.assets acc
       WHERE resource_type = 'GCP::Logging::Metric'
         AND regexp_replace(acc."configuration" ->> 'filter_', E'[\\n\\r\\f\\u000B\\u0085\\u2028\\u2029]+', ' ', 'g') =
             'resource.type="iam_role" AND protoPayload.methodName="google.iam.admin.v1.CreateRole" OR protoPayload.methodName="google.iam.admin.v1.DeleteRole" OR protoPayload.methodName="google.iam.admin.v1.UpdateRole"'
         AND EXISTS (
              SELECT alrt.asset_id, metric
                FROM magpie.assets alrt,
              LATERAL (
                    SELECT value -> 'condition_' ->> 'filter_' as metric
                    FROM jsonb_array_elements(alrt.configuration -> 'conditions_')
              ) arr
               WHERE alrt.resource_type = 'GCP::Monitoring::AlertPolicy'
                 AND alrt."configuration" -> 'enabled_' ->> 'value_' = 'true'
                 AND metric ILIKE '%'||acc.asset_id||'%'
         )
  )
remediationDocURLs: https://github.com/openraven/security-rules/wiki
version: 0.9