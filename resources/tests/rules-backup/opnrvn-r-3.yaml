# id: f6585eff-ff81-4d39-a9fe-f883feb6e531
ruleId: opnrvn-r-3
type: asset
ruleName: >
  Ensure CloudTrail is enabled in all regions
description: >
  AWS CloudTrail is a web service that records AWS API calls for your account and delivers
  log files to you. The recorded information includes the identity of the API caller, the time of
  the API call, the source IP address of the API caller, the request parameters, and the
  response elements returned by the AWS service. CloudTrail provides a history of AWS API
  calls for an account, including API calls made via the Management Console, SDKs, command
  line tools, and higher-level AWS services (such as CloudFormation)
severity: high
enabled: true
sql: >
  SELECT 'No global trail exists' AS asset_id
  WHERE NOT EXISTS
      (SELECT *
       FROM magpie.aws
       WHERE resourcetype = 'AWS::CloudTrail::Trail'
         AND supplementary_configuration->'trailDetails'->'trail'->'isMultiRegionTrail' = 'true'
         AND supplementary_configuration->'status'->'isLogging' = 'true'
         AND EXISTS
           (SELECT *
            FROM jsonb_array_elements(supplementary_configuration->'eventSelectors'->'eventSelectors') eventSelector
            WHERE eventSelector->>'includeManagementEvents' = 'true'
              AND eventSelector->>'readWriteType' = 'All'));
remediationDocURLs: https://github.com/openraven/security-rules/wiki
version: 0.9
